name: Build DebugProbe UF2 (Optimized)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout debugprobe repo
    - uses: actions/checkout@v3
      with:
        submodules: recursive  # fetch Pico SDK once

    # 2. Set up caching for Pico SDK
    - name: Cache Pico SDK
      uses: actions/cache@v3
      with:
        path: external/pico-sdk
        key: pico-sdk-${{ hashFiles('external/pico-sdk/**') }}
        restore-keys: |
          pico-sdk-

    # 3. Set up caching for ARM toolchain
    - name: Cache ARM GCC
      uses: actions/cache@v3
      with:
        path: /usr/bin/arm-none-eabi-gcc
        key: arm-gcc-11  # adjust if using a different version

    # 4. Install dependencies
    - name: Install ARM GCC, CMake, Ninja
      run: |
        sudo apt update
        sudo apt install -y gcc-arm-none-eabi cmake ninja-build build-essential git

    # 5. Build debugprobe firmware
    - name: Build debugprobe_on_pico.uf2
      run: |
        mkdir -p build
        cd build
        cmake -DDEBUG_ON_PICO=ON -DPICO_SDK_FETCH_FROM_GIT=ON -G Ninja ..
        ninja

    # 6. Upload UF2 artifact
    - name: Upload UF2
      uses: actions/upload-artifact@v4
      with:
        name: debugprobe-uf2
        path: build/*.uf2
